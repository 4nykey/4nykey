--- configure.in.orig	2004-03-13 15:24:19.783147336 +0100
+++ configure.in	2004-03-13 15:24:48.430792232 +0100
@@ -67,7 +67,7 @@
         [HAVE_FPOS_T_POS])
 
 
-external_mp4v2=yes
+AC_CHECK_PROG(external_mp4v2, mpeg4ip-config, yes, no)
 AC_CHECK_LIB(mp4v2, MP4Create, , external_mp4v2=no, -lstdc++)
 AC_CHECK_LIB(mp4v2, MP4MetadataDelete, , external_mp4v2=no, -lstdc++)
 AC_CHECK_HEADER(mp4.h, , external_mp4v2=no)
--- common/Makefile.am.orig	2005-05-19 21:15:51.765432440 +0300
+++ common/Makefile.am	2005-05-19 21:16:25.171353968 +0300
@@ -1,5 +1,9 @@
 if WITH_MP4V2
+if HAVE_MPEG4IP
+SUBDIRS = mp4ff
+else
 SUBDIRS = mp4v2 mp4ff
+endif
 else
 SUBDIRS = mp4ff
 endif
--- plugins/Makefile.am.orig	2005-05-19 21:23:45.730378816 +0300
+++ plugins/Makefile.am	2005-05-19 21:24:13.817108984 +0300
@@ -1,13 +1,5 @@
-if HAVE_MPEG4IP
-if HAVE_XMMS
-SUBDIRS = mpeg4ip xmms
-else
-SUBDIRS = mpeg4ip
-endif
-else
 if HAVE_XMMS
 SUBDIRS = xmms
 else
 SUBDIRS =
 endif
-endif
--- plugins/xmms/src/Makefile.am.orig	2004-02-06 18:05:07.000000000 +0200
+++ plugins/xmms/src/Makefile.am	2005-05-19 21:29:54.492318480 +0300
@@ -5,8 +5,13 @@
        `$(GTK_CONFIG) --cflags` -DHAVE_GLIB_H=1 \
        -I$(top_srcdir)/include -I$(top_srcdir)/common/mp4v2
 
-libmp4_la_LIBADD = $(top_builddir)/libfaad/libfaad.la \
-       $(top_builddir)/common/mp4v2/libmp4v2.la
+libmp4_la_LIBADD = $(top_builddir)/libfaad/libfaad.la
+if HAVE_MPEG4IP
+libmp4_la_LIBADD += -lmp4v2
+else
+libmp4_la_LIBADD += $(top_builddir)/common/mp4v2/libmp4v2.la
+endif
+
 
 libmp4_la_LDFLAGS = -module -avoid-version `$(XMMS_CONFIG) --libs` \
        `$(GTK_CONFIG) --libs` -lpthread -lstdc++
